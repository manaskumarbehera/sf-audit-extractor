<!-- html
File: `popup.html` (replace body content with this)
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Salesforce Audit Trail Extractor</title>
    <link rel="stylesheet" href="popup.css" />
</head>
<body>
<div class="container">
    <header class="tabs-header">
        <div class="tabs-left">
            <nav class="tabs" role="tablist" aria-label="Views">
                <button class="tab-button active" role="tab" aria-selected="true" data-tab="sf">Audit Trails</button>
                <button class="tab-button" role="tab" aria-selected="false" data-tab="platform">Platform Events</button>
                <button class="tab-button" role="tab" aria-selected="false" data-tab="lms">Lightning Message Service</button>
                <button class="tab-button" role="tab" aria-selected="false" data-tab="soql">SOQL Query Builder</button>
                <button class="tab-button" role="tab" aria-selected="false" data-tab="graphql">GraphQL Query Builder</button>
                <button class="tab-button" role="tab" aria-selected="false" data-tab="data">Data Explorer</button>
                <button class="tab-button" role="tab" aria-selected="false" data-tab="settings">Settings</button>
                <button class="tab-button" role="tab" aria-selected="false" data-tab="help">Help</button>
                <button class="tab-button" role="tab" aria-selected="false" data-tab="about">About</button>
            </nav>
        </div>

        <div class="tabs-right">
            <h1 id="header-title">Audit Trails</h1>
            <div class="status" id="status">
                <span class="status-dot"></span>
                <span class="status-text">Not connected</span>
            </div>
            <label for="api-version" class="api-version-label" title="Salesforce API version">API</label>
            <select id="api-version" class="api-version-select" aria-label="Salesforce API version">
                <option value="65.0">65.0</option>
                <option value="64.0">64.0</option>
                <option value="63.0">63.0</option>
                <option value="62.0">62.0</option>
                <option value="61.0">61.0</option>
                <option value="60.0">60.0</option>
            </select>
            <button id="app-pop" class="header-icon-btn" aria-label="Pop out window" title="Pop out window"></button>
        </div>
    </header>

    <section class="tab-contents">
        <div id="tab-sf" class="tab-pane" data-tab="sf" style="display: block;">
            <div class="audit-header">
                <div class="audit-left">
                    <div class="audit-controls">
                        <button id="fetch-btn" class="icon-btn" aria-label="Fetch Audit Logs" title="Fetch Audit Logs">
                            <span aria-hidden="true">‚ü≤</span>
                        </button>
                        <button id="export-btn" class="icon-btn" aria-label="Export CSV" title="Export CSV" disabled>
                            <span aria-hidden="true">‚Üì</span>
                        </button>
                    </div>
                </div>
                <div class="audit-right"></div>
            </div>

            <div class="search-box">
                <input type="text" id="search-input" placeholder="Search audit logs..." aria-label="Search audit logs" disabled />
            </div>

            <div class="filters">
                <label class="filter-label" for="category-filter">Category:</label>
                <select id="category-filter" disabled>
                    <option value="all">All Categories</option>
                    <option value="User Management">User Management</option>
                    <option value="Security">Security</option>
                    <option value="Object Changes">Object Changes</option>
                </select>
            </div>

            <div class="stats" id="stats" style="display: none;">
                <div class="stat-item">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value" id="total-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">User Mgmt:</span>
                    <span class="stat-value" id="user-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Security:</span>
                    <span class="stat-value" id="security-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Objects:</span>
                    <span class="stat-value" id="object-count">0</span>
                </div>
            </div>

            <div class="logs-container" id="logs-container">
                <div class="placeholder">
                    <p>Audit logs are not loaded yet</p>
                    <p class="placeholder-note">Use the refresh icon to fetch audit logs</p>
                </div>
            </div>
        </div>

        <div id="tab-platform" class="tab-pane" data-tab="platform" hidden>
            <div class="platform-header">
                <div class="platform-left">
                    <div class="platform-controls">
                        <button id="pe-refresh" class="icon-btn" aria-label="Fetch Platform Events" title="Fetch Platform Events">
                            <span aria-hidden="true">‚ü≤</span>
                        </button>
                    </div>
                </div>
                <div class="platform-right">
                    <div class="status" id="cometd-status" title="Disconnected">
                        <span class="status-dot"></span>
                        <span class="status-text">Disconnected</span>
                    </div>
                </div>
            </div>

            <div class="platform-content">
                <div class="platform-events">
                    <h2 class="section-title">Platform Events</h2>
                    <div id="platform-events-list" class="list">
                        <div class="placeholder">
                            <p>No events loaded</p>
                            <p class="placeholder-note">Click the refresh icon to load Platform Events</p>
                        </div>
                    </div>
                </div>
                <div class="platform-log">
                    <h2 class="section-title">Event Messages</h2>
                    <div class="log-toolbar">
                        <div class="toolbar-left">
                            <button id="pe-log-clear" class="icon-btn btn-sm" aria-label="Clear log" title="Clear log"><span aria-hidden="true">üóë</span></button>
                            <button id="pe-log-pause" class="icon-btn btn-sm" aria-pressed="false" aria-label="Pause logging" title="Pause logging"><span aria-hidden="true">‚è∏</span></button>
                        </div>
                        <div class="toolbar-right">
                            <button id="pe-log-autoscroll-btn" class="icon-btn btn-sm" aria-pressed="true" aria-label="Toggle auto-scroll" title="Auto-scroll: on"><span aria-hidden="true">‚§ì</span></button>
                            <select id="pe-log-filter" class="log-filter compact" aria-label="Filter">
                                <option value="all" selected>All</option>
                                <option value="event">Events</option>
                                <option value="system">System</option>
                                <option value="subscribe">Subscribe</option>
                                <option value="unsubscribe">Unsubscribe</option>
                                <option value="error">Errors</option>
                            </select>
                        </div>
                    </div>
                    <div id="platform-event-log" class="logs-container">
                        <div class="placeholder-note">No messages yet</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-lms" class="tab-pane" data-tab="lms" hidden>
            <div class="audit-header">
                <div class="audit-left">
                    <div class="audit-controls">
                        <button id="lms-refresh" class="icon-btn" aria-label="Fetch LMS Channels" title="Fetch LMS Channels">
                            <span aria-hidden="true">‚ü≤</span>
                        </button>
                        <!-- No publish button: sample payload only -->
                    </div>
                </div>
                <div class="audit-right"></div>
            </div>

            <div class="filters" style="gap: 8px;">
                <label class="filter-label" for="lms-channel">Channel:</label>
                <select id="lms-channel" disabled>
                    <option value="">Select a message channel</option>
                </select>
            </div>

            <!-- Sample payload view (no publish) -->
            <div class="search-box">
                <div class="sample-payload-wrap">
                    <textarea id="lms-payload" rows="6" placeholder='Sample payload will appear here after selecting a channel' aria-label="Sample LMS payload"></textarea>
                    <button id="lms-payload-copy" class="icon-btn copy-overlay-btn" aria-label="Copy sample payload" title="Copy sample payload">üìã</button>
                </div>
            </div>

            <div id="lms-log" class="logs-container">
                <div class="placeholder-note">No LMS activity yet</div>
            </div>
        </div>

        <div id="tab-soql" class="tab-pane" data-tab="soql" hidden>
            <div class="filters" style="gap: 8px; align-items: center;">
                <label class="filter-label" for="soql-tooling">Tooling API:</label>
                <input type="checkbox" id="soql-tooling" aria-label="Use Tooling API">


                <div id="soql-object-group" style="display: inline-flex; align-items: center; gap: 8px;">
                    <label class="filter-label" for="soql-object">SObject:</label>
                    <select id="soql-object" aria-label="Select SObject" autocomplete="off">
                        <option value="">Select an object</option>
                    </select>
                </div>

                <!-- New: limit control -->
                <label class="filter-label" for="soql-limit" title="Max records to fetch">Limit:</label>
                <input id="soql-limit" type="number" min="1" max="5000" value="200" style="width: 90px; padding: 6px 8px;" aria-label="Max records to fetch" />


                <button id="soql-run" class="icon-btn btn-sm" title="Run Query" aria-label="Run Query">
                    <span aria-hidden="true">‚ñ∂</span>
                </button>
                <button id="soql-clear" class="icon-btn btn-sm" title="Clear results" aria-label="Clear results">
                    <span aria-hidden="true">üóë</span>
                </button>
            </div>

            <!-- SOQL query tabs bar -->
            <div id="soql-tabs" class="soql-tabbar" role="tablist" aria-label="SOQL query tabs">
                <div class="soql-tablist"></div>
                <button id="soql-tab-add" class="icon-btn btn-sm" title="New query tab" aria-label="New query tab">Ôºã</button>
            </div>

            <!-- Guided query builder toggle and panel -->
            <div class="soql-builder-toggle">
                <label class="builder-toggle-label">
                    <input type="checkbox" id="soql-builder-enabled" aria-label="Enable guided query builder" />
                    <span>Guided builder</span>
                </label>
                <span class="soql-builder-hint">Compose a query with fields and filters, or turn it off to hand-write SOQL.</span>
            </div>
            <div id="soql-builder" class="soql-builder" hidden>
                <div class="builder-row">
                    <div class="builder-col">
                        <div class="builder-section" aria-label="Select fields">
                            <div class="builder-section-header">
                                <span class="builder-title">Fields</span>
                                <button id="soql-builder-add-field" class="btn-chip" type="button" title="Add field">+ Add</button>
                            </div>
                            <div class="builder-field-add">
                                <input id="soql-builder-field-input" list="soql-builder-field-list" placeholder="Start typing a field" aria-label="Field to add" />
                                <datalist id="soql-builder-field-list"></datalist>
                            </div>
                            <div id="soql-builder-fields" class="chip-wrap builder-chip-wrap" aria-live="polite"></div>
                        </div>
                    </div>
                    <div class="builder-col">
                        <div class="builder-section" aria-label="Add filters">
                            <div class="builder-section-header">
                                <span class="builder-title">Filters</span>
                                <button id="soql-builder-add-filter" class="btn-chip" type="button" title="Add filter">+ Filter</button>
                            </div>
                            <div id="soql-builder-filters" class="builder-filters" aria-live="polite"></div>
                        </div>
                    </div>
                </div>
                <div class="builder-row">
                    <div class="builder-col">
                        <div class="builder-section" aria-label="Order by">
                            <div class="builder-section-header">
                                <span class="builder-title">Order by</span>
                                <button id="soql-builder-clear-order" class="icon-btn btn-sm" type="button" title="Clear ordering">‚úï</button>
                            </div>
                            <div class="builder-inline">
                                <input id="soql-builder-order-field" list="soql-builder-field-list" placeholder="Field" aria-label="Order by field" />
                                <select id="soql-builder-order-dir" aria-label="Order direction">
                                    <option value="asc">ASC</option>
                                    <option value="desc">DESC</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="builder-col">
                        <div class="builder-section builder-note-section" aria-label="Builder status">
                            <div class="builder-title">Builder status</div>
                            <div class="builder-note">Limit uses the control above. Tooling toggle also applies here.</div>
                            <div id="soql-builder-status" class="builder-status" aria-live="polite"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="search-box">
                <textarea id="soql-query" rows="6" placeholder="SELECT Id, Name FROM Account LIMIT 10" aria-label="SOQL query"></textarea>
                <div id="soql-guidance" class="soql-guidance" aria-live="polite">
                    <div class="soql-guidance-card">
                        <div class="soql-guidance-card-title">Write a focused SOQL query</div>
                        <div class="soql-guidance-card-message">Start by selecting a small field list and limit the records you pull back.</div>
                    </div>
                    <div class="soql-guidance-flags" role="list"></div>
                </div>
            </div>

            <!-- Unified action bar: Advanced toggle + export buttons -->
            <div class="soql-actionbar" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; padding:6px 0;">
                <label class="filter-label" for="soql-view-advanced" title="Toggle Advanced Results" style="margin-right:4px;">Advanced:</label>
                <input type="checkbox" id="soql-view-advanced" role="switch" aria-label="Advanced results view (on/off)" style="margin-right:16px;" />
                <span id="soql-status" style="margin-right:auto; font-size:12px; color:#555; padding:2px 4px;">Raw view</span>
                <div id="soql-export-buttons" style="display:none; gap:8px; align-items:center;">
                  <button class="btn-chip" id="soql-exp-json" title="Copy JSON to clipboard"><span class="ico">üìã</span><span class="lbl">JSON</span></button>
                  <button class="btn-chip" id="soql-exp-csv" title="Copy CSV to clipboard"><span class="ico">üìã</span><span class="lbl">CSV</span></button>
                  <button class="btn-chip" id="soql-exp-tsv" title="Copy TSV (Excel) to clipboard"><span class="ico">üìã</span><span class="lbl">Excel</span></button>
                  <button class="btn-chip" id="soql-exp-download" title="Download CSV file"><span class="ico">‚¨áÔ∏è</span><span class="lbl">Download CSV</span></button>
                </div>
            </div>
            <div id="soql-results" class="logs-container">

            </div>
        </div>
        <div id="tab-graphql" class="tab-pane" data-tab="graphql" hidden>
            <div class="logs-container">
                <div class="placeholder">
                    <p>GraphQL Query Builder</p>
                    <p class="placeholder-note">Coming soon. Create GraphQL queries for Salesforce APIs.</p>
                </div>
            </div>
        </div>
        <div id="tab-data" class="tab-pane" data-tab="data" hidden>
            <div class="logs-container">
                <div class="placeholder">
                    <p>Data Explorer</p>
                    <p class="placeholder-note">Coming soon. Explore SObjects and fields.</p>
                </div>
            </div>
        </div>
        <div id="tab-settings" class="tab-pane" data-tab="settings" hidden>
            <div class="logs-container">
                <div class="placeholder">
                    <p>Settings</p>
                    <p class="placeholder-note">Configure preferences for the extension.</p>
                </div>
            </div>
        </div>
        <div id="tab-help" class="tab-pane" data-tab="help" hidden>
            <div class="logs-container">
                <div class="placeholder">
                    <p>Help</p>
                    <p class="placeholder-note">Find docs, tips, and troubleshooting here.</p>
                </div>
            </div>
        </div>
        <div id="tab-about" class="tab-pane" data-tab="about" hidden>
            <div class="logs-container">
                <div class="placeholder">
                    <p>About</p>
                    <p class="placeholder-note">Salesforce Audit Trail Extractor ‚Äî version information and credits.</p>
                </div>
            </div>
        </div>

    </section>
    <footer class="app-footer" role="contentinfo">
        <div class="footer-inner">
            <span>Developed by </span>
            <a href="https://www.linkedin.com/in/manas-behera-68607547/" target="_blank" rel="noopener noreferrer">Manas Behera</a>
        </div>
    </footer>
</div>

<script src="utils.js"></script>
<script src="platform_helper.js"></script>
<script src="lms_helper.js"></script>
<script src="audit_helper.js"></script>
<script src="soql_helper.js"></script>
<script src="scripts/soql/soql_guidance_engine.js"></script>
<script src="scripts/soql/soql_guidance.js"></script>
<script type="module" src="popup.js"></script>
</body>
</html>
